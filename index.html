<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Heartbeat and Temperature Data Chart</title>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://code.highcharts.com/modules/export-data.js"></script>
    <script src="https://code.highcharts.com/modules/accessibility.js"></script>
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.0.14/src/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.0/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        .highcharts-figure, .highcharts-data-table table {
            min-width: 320px;
            max-width: 1000px;
            margin: 1em auto;
        }

        #container {
            height: 400px;
        }

        iframe {
            width: 100%;
            height: 300px;
            border: 1px solid #ccc;
        }

        .highcharts-tooltip {
            font-size: 20px;
        }

        .highcharts-area {
            fill-opacity: 0.3;
        }
    </style>
</head>
<body>
    <figure class="highcharts-figure">
        <div id="container"></div>
        <p class="highcharts-description">Chart showing heartbeats and temperature data updating every second.</p>
        <button id="exportButton">Export to Excel</button>
    </figure>

    <!-- Checkbox for heartbeat -->
    <input type="checkbox" id="HeartBeat"></input>

    <!-- Iframe for displaying CSV data -->
    <iframe id="csv-iframe"></iframe>

    <script>
        const eraWidget = new EraWidget();
        let config = null;
        let heartbeatValue = 0;
        let temperatureValue = 25; // Assuming initial temperature value
        const dataBuffer = [];
        const temperatureBuffer = [];

        eraWidget.onConfiguration((configuration) => {
            config = configuration.realtime_configs[0];
        });

        eraWidget.onValues((values) => {
            const input = document.getElementById('HeartBeat');
            heartbeatValue = values[config.id].value; // Get live heartbeat value
            input.checked = heartbeatValue > 0; // Update checkbox based on heartbeat
        });

        eraWidget.ready();

        const onChartLoad = function () {
            const chart = this,
                series1 = chart.series[0], // Heartbeat series
                series2 = chart.series[1]; // Temperature series

            setInterval(function () {
                const x = (new Date()).getTime();
                const y1 = heartbeatValue;
                const y2 = temperatureValue;

                series1.addPoint([x, y1], true, true);
                series2.addPoint([x, y2], true, true);

                dataBuffer.push([x, y1]);
                temperatureBuffer.push([x, y2]);
            }, 1000);
        };

        const data = (function () {
            const data = [];
            const time = (new Date().getTime());
            for (let i = -19; i <= 0; i += 1) {
                data.push({
                    x: time + i * 1000,
                    y: 0 // Default value for initial data
                });
            }
            return data;
        }());

        Highcharts.chart('container', {
            chart: {
                type: 'areaspline',
                events: {
                    load: onChartLoad
                }
            },
            time: {
                useUTC: false
            },
            title: {
                text: 'Live Heartbeat and Temperature Data'
            },
            xAxis: {
                type: 'datetime',
                tickPixelInterval: 150,
                maxPadding: 0.1
            },
            yAxis: [{
                title: {
                    text: 'Heartbeat'
                },
                min: 0,
                max: 130,
                tickInterval: 10
            }, {
                title: {
                    text: 'Temperature'
                },
                opposite: true,
                min: 0,
                max: 40,
                tickInterval: 5
            }],
            tooltip: {
                headerFormat: '<b>{series.name}</b><br/>',
                pointFormat: '{point.x:%Y-%m-%d %H:%M:%S}<br/>{point.y:.2f}'
            },
            series: [{
                name: 'Heartbeats',
                data: data
            }, {
                name: 'Temperature',
                yAxis: 1,
                data: temperatureBuffer // Temperature data, updated with each second
            }]
        });

        document.getElementById('exportButton').addEventListener('click', function () {
            const ws = XLSX.utils.json_to_sheet(dataBuffer.map(point => ({
                Time: (new Date(point[0])).toLocaleString(),
                Heartbeat: point[1],
                Temperature: temperatureBuffer[dataBuffer.indexOf(point)] ? temperatureBuffer[dataBuffer.indexOf(point)][1] : null
            })));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Heartbeats and Temperature');
            XLSX.writeFile(wb, 'heartbeat_temperature_data.xlsx');
        });

        // Read and display CSV data
        const csvUrl = 'https://github.com/phuonguyen1803/E_RA/blob/main/hourly_weather_data.csv
        Papa.parse(csvUrl, {
            download: true,
            header: true,
            dynamicTyping: true,
            complete: function(results) {
                const iframe = document.getElementById('csv-iframe');
                const iframeDocument = iframe.contentDocument || iframe.contentWindow.document;

                const table = document.createElement('table');
                const header = table.createTHead();
                const row = header.insertRow();

                // Only show Time, Temperature, Humidity
                const columns = ['time', 'temperature', 'humidity'];
                columns.forEach(function(col) {
                    const cell = row.insertCell();
                    cell.textContent = col.charAt(0).toUpperCase() + col.slice(1);
                });

                const tbody = table.createTBody();
                results.data.forEach(function(record) {
                    const row = tbody.insertRow();
                    columns.forEach(function(col) {
                        const cell = row.insertCell();
                        cell.textContent = record[col] || ''; // Handle undefined values
                    });
                });

                iframeDocument.body.appendChild(table);
            }
        });

    </script>

</body>
</html>
